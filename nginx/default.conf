# =========================
# HTTP → HTTPS Redirect
# =========================
server {
    listen 80;
    server_name smart-licensing.site www.smart-licensing.site;

    # אתגרי Let's Encrypt
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$host$request_uri;
    }
}

# =========================
# HTTPS + Frontend + API
# =========================
server {
    listen 443 ssl http2;
    server_name smart-licensing.site www.smart-licensing.site;

    ssl_certificate     /etc/letsencrypt/live/smart-licensing.site/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/smart-licensing.site/privkey.pem;

    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), bluetooth=()" always;

    add_header Content-Security-Policy "default-src 'self'; base-uri 'self'; object-src 'none'; frame-ancestors 'self'; img-src 'self' data: blob:; font-src 'self' data:; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com; script-src 'self' https://cdn.tailwindcss.com https://unpkg.com; connect-src 'self'; form-action 'self'; upgrade-insecure-requests" always;

    # -------- סטטיים (Frontend) --------
    root  /usr/share/nginx/html;

    # קאשינג אגרסיבי לקבצים סטטיים לפי סיומת
    location ~* \.(?:js|css|png|jpg|jpeg|gif|svg|webp|ico|woff2?)$ {
        access_log off;
        expires 30d;
        add_header Cache-Control "public, max-age=2592000, immutable" always;
        try_files $uri =404;
    }

    # עמודי SPA: כל נתיב שאינו קובץ אמיתי → index.html
    location / {
        index index.html;
        try_files $uri /index.html;   # SPA fallback
    }

    # -------- API Proxy --------
    location ^~ /api {
        proxy_pass http://licensing-api:5000;
        proxy_http_version 1.1;

        # כותרות פרוקסי
        proxy_set_header Host               $host;
        proxy_set_header X-Real-IP          $remote_addr;
        proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto  $scheme;

        # אם יש צורך ב-CORS חוצה דומיינים (כרגע לא): בטל תגובה והוסף allow-origin מתאים.
        # add_header Access-Control-Allow-Origin "https://smart-licensing.site" always;
        # add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
        # add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
        # if ($request_method = OPTIONS) { return 204; }

        # Timeouts להימנע מ-504 בעת קריאות AI ארוכות
        proxy_connect_timeout   300;
        proxy_send_timeout      300;
        proxy_read_timeout      300;
        send_timeout            300;

        # Buffering יכול לעזור ליציבות
        proxy_buffering on;
        proxy_buffers 16 32k;
        proxy_busy_buffers_size 64k;
        proxy_temp_file_write_size 64k;
    }

    # -------- דחיסה --------
    gzip on;
    gzip_comp_level 5;
    gzip_min_length 256;
    gzip_types text/plain text/css application/javascript application/json application/xml image/svg+xml;
    gzip_proxied any;

    # -------- הגבלות כלליות --------
    client_max_body_size 10m;

    # דפי שגיאה (רשות)
    error_page 404 /index.html;         # SPA
    error_page 500 502 503 504 /50x.html;
    location = /50x.html { try_files /50x.html =502; }
}